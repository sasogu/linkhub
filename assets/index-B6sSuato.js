(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=o(n);fetch(n.href,a)}})();const J=document.querySelector("#app");J.innerHTML=`
  <h1>LinkHub</h1>
  <div id="dropbox-bar" style="display:flex;gap:0.5em;align-items:center;margin-bottom:0.75em;">
    <span id="dropbox-status" style="font-size:0.9em;color:#888;">Dropbox: desconectado</span>
    <button id="dropbox-connect" type="button">Conectar Dropbox</button>
    <button id="dropbox-sync" type="button" disabled>Sincronizar ahora</button>
    <button id="dropbox-disconnect" type="button" disabled>Desconectar</button>
  </div>
  <form id="link-form">
    <input type="url" id="url" placeholder="Enlace (https://...)" required />
    <input type="text" id="title" placeholder="Título" required />
    <input type="text" id="tags" placeholder="Etiquetas (separadas por coma)" />
    <input type="text" id="category" placeholder="Categoría" />
    <button type="submit">Añadir enlace</button>
  </form>
  <div style="margin:1em 0;">
    <button id="export-btn">Exportar enlaces</button>
    <input type="file" id="import-file" accept="application/json" style="display:none;" />
    <button id="import-btn" type="button">Importar enlaces</button>
  </div>
  <div style="margin:1em 0;">
    <input type="text" id="search" placeholder="Buscar enlaces..." style="width:60%;max-width:400px;" />
  </div>
  <div style="margin:1em 0;">
    <label>Filtrar por categoría:
      <select id="filter-category">
        <option value="">Todas</option>
      </select>
    </label>
    <label style="margin-left:1em;">Filtrar por etiqueta:
      <select id="filter-tag">
        <option value="">Todas</option>
      </select>
    </label>
  </div>
  <h2>Enlaces guardados</h2>
  <div id="links-list"></div>
`;const d=document.getElementById("link-form"),j=document.getElementById("links-list"),z=document.getElementById("export-btn"),H=document.getElementById("import-btn"),_=document.getElementById("import-file"),O=document.getElementById("filter-category"),D=document.getElementById("filter-tag"),N=document.getElementById("search"),m=document.getElementById("dropbox-status"),A=document.getElementById("dropbox-connect"),E=document.getElementById("dropbox-sync"),L=document.getElementById("dropbox-disconnect");function p(){return JSON.parse(localStorage.getItem("links")||"[]")}function k(e){localStorage.setItem("links",JSON.stringify(e)),localStorage.setItem("linksUpdatedAt",String(Date.now())),P()}function M(e){return Array.from(new Set(e.map(t=>(t.category||"").trim()).filter(Boolean)))}function K(e){return Array.from(new Set(e.flatMap(t=>(t.tags||[]).map(o=>o.trim())).filter(Boolean)))}function b(){const e=p(),t=M(e).sort((r,n)=>r.localeCompare(n,"es",{sensitivity:"base"})),o=K(e).sort((r,n)=>r.localeCompare(n,"es",{sensitivity:"base"}));O.innerHTML='<option value="">Todas</option>'+t.map(r=>`<option value="${r}">${r}</option>`).join(""),D.innerHTML='<option value="">Todas</option>'+o.map(r=>`<option value="${r}">${r}</option>`).join("")}function f(){const e=p();let t=e;const o=O.value,r=D.value,n=(N.value||"").toLowerCase();if(o&&(t=t.filter(i=>(i.category||"")===o)),r&&(t=t.filter(i=>(i.tags||[]).map(String).includes(r))),n&&(t=t.filter(i=>i.title&&i.title.toLowerCase().includes(n)||i.url&&i.url.toLowerCase().includes(n)||i.category&&i.category.toLowerCase().includes(n)||i.tags&&i.tags.join(",").toLowerCase().includes(n))),t.length===0){j.innerHTML="<p>No hay enlaces guardados.</p>";return}const a=t.filter(i=>i.pinned),c=t.filter(i=>!i.pinned);a.sort((i,s)=>(i.title||"").localeCompare(s.title||"","es",{sensitivity:"base"})),c.sort((i,s)=>(i.title||"").localeCompare(s.title||"","es",{sensitivity:"base"}));const w=i=>i.map((s,l)=>`
    <div class="link-item${s.pinned?" pinned":""}" data-idx="${e.indexOf(s)}">
      <a href="${s.url}" target="_blank">${s.title}</a>
      <div><strong>Categoría:</strong> ${s.category||"-"}</div>
      <div><strong>Etiquetas:</strong> ${s.tags?s.tags.join(", "):"-"}</div>
      <button class="edit-link" style="margin-top:0.5em;">Editar</button>
      <button class="pin-link" style="margin-top:0.5em;">${s.pinned?"Desfijar":"Fijar"}</button>
      <button class="delete-link" style="margin-top:0.5em;color:#c00;background:#fff3f3;border:1px solid #c00;">Eliminar</button>
      <button class="share-link" style="margin-top:0.5em;color:#1a7f37;background:#e6fff3;border:1px solid #1a7f37;">Compartir</button>
    </div>
  `).join("");j.innerHTML=(a.length?'<div style="font-size:0.95em;color:#535bf2;margin-bottom:0.5em;">Fijados</div>'+w(a):"")+w(c),document.querySelectorAll(".edit-link").forEach(i=>{i.onclick=function(){const s=this.parentElement.getAttribute("data-idx"),l=p()[s];d.url.value=l.url,d.title.value=l.title,d.tags.value=(l.tags||[]).join(", "),d.category.value=l.category||"",d.setAttribute("data-edit",s),d.querySelector('button[type="submit"]').textContent="Guardar cambios",d.scrollIntoView({behavior:"smooth"})}}),document.querySelectorAll(".pin-link").forEach(i=>{i.onclick=function(){const s=this.parentElement.getAttribute("data-idx"),l=p();l[s].pinned=!l[s].pinned,k(l),f()}}),document.querySelectorAll(".delete-link").forEach(i=>{i.onclick=function(){const s=this.parentElement.getAttribute("data-idx");if(confirm("¿Seguro que quieres eliminar este enlace?")){const l=p();l.splice(s,1),k(l),f(),b()}}}),document.querySelectorAll(".share-link").forEach(i=>{i.onclick=function(){const s=this.parentElement.getAttribute("data-idx"),l=p()[s];navigator.share?navigator.share({title:l.title,text:l.title+(l.category?" ["+l.category+"]":""),url:l.url}):(navigator.clipboard.writeText(l.url),alert("Enlace copiado al portapapeles"))}})}d.addEventListener("submit",e=>{e.preventDefault();const t=d.url.value.trim(),o=d.title.value.trim(),r=d.tags.value.split(",").map(w=>w.trim()).filter(Boolean),n=d.category.value.trim(),a=p(),c=d.getAttribute("data-edit");c!==null?(a[c]={url:t,title:o,tags:r,category:n},d.removeAttribute("data-edit"),d.querySelector('button[type="submit"]').textContent="Añadir enlace"):a.push({url:t,title:o,tags:r,category:n}),k(a),d.reset(),f(),b()});z.addEventListener("click",()=>{const e=p(),t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),o=URL.createObjectURL(t),r=document.createElement("a");r.href=o,r.download="enlaces-linkhub.json",r.click(),URL.revokeObjectURL(o)});H.addEventListener("click",()=>{_.click()});_.addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const o=new FileReader;o.onload=r=>{try{const n=JSON.parse(r.target.result);Array.isArray(n)?(k(n),f(),b(),alert("Enlaces importados correctamente.")):alert("El archivo no tiene el formato esperado.")}catch{alert("Error al importar el archivo.")}},o.readAsText(t),_.value=""});O.addEventListener("change",()=>{f()});D.addEventListener("change",()=>{f()});N.addEventListener("input",f);b();f();const y=window.VITE_DROPBOX_APP_KEY||"",I="/linkhub/links.json";let u=null,v=null,S=!1;function g(e,t){e?(m.textContent=`Dropbox: conectado${t?" ("+t+")":""}`,m.style.color="#1a7f37",A.disabled=!0,E.disabled=!1,L.disabled=!1):(m.textContent="Dropbox: desconectado",m.style.color="#888",A.disabled=!y,E.disabled=!0,L.disabled=!0)}function h(){return Date.now()}function T(){try{return JSON.parse(localStorage.getItem("dropboxAuth")||"null")}catch{return null}}function C(e){u=e,e?localStorage.setItem("dropboxAuth",JSON.stringify(e)):localStorage.removeItem("dropboxAuth")}async function V(e){const o=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",o),n=new Uint8Array(r);let a="";for(let c=0;c<n.length;c++)a+=String.fromCharCode(n[c]);return btoa(a).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function X(e=64){const t=new Uint8Array(e);return crypto.getRandomValues(t),Array.from(t).map(o=>("0"+o.toString(16)).slice(-2)).join("")}async function Y(){if(!y){alert("Falta configurar VITE_DROPBOX_APP_KEY.");return}const e=X(64),t=await V(e);sessionStorage.setItem("dbx_code_verifier",e);const o=window.location.origin+window.location.pathname,n=`https://www.dropbox.com/oauth2/authorize?${new URLSearchParams({client_id:y,response_type:"code",code_challenge:t,code_challenge_method:"S256",token_access_type:"offline",redirect_uri:o}).toString()}`;window.location.assign(n)}async function G(e){const t=sessionStorage.getItem("dbx_code_verifier"),o=window.location.origin+window.location.pathname,r=new URLSearchParams({code:e,grant_type:"authorization_code",client_id:y,redirect_uri:o,code_verifier:t||""}),n=await fetch("https://api.dropboxapi.com/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r});if(!n.ok)throw new Error("No se pudo obtener el token de Dropbox");const a=await n.json(),c=h()+(a.expires_in?a.expires_in*1e3-60*1e3:3*3600*1e3);C({access_token:a.access_token,refresh_token:a.refresh_token||null,expires_at:c,account_id:a.account_id||null})}async function U(){if(!u?.refresh_token)return!1;const e=new URLSearchParams({grant_type:"refresh_token",refresh_token:u.refresh_token,client_id:y}),t=await fetch("https://api.dropboxapi.com/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e});if(!t.ok)return!1;const o=await t.json();return u.access_token=o.access_token,u.expires_at=h()+(o.expires_in?o.expires_in*1e3-60*1e3:3*3600*1e3),C(u),!0}async function B(){return u=u||T(),!u||u.expires_at&&u.expires_at<h()&&!await U()?null:u.access_token}async function x(e,t,o={}){const r=await B();if(!r)throw new Error("No autenticado en Dropbox");const n=Object.assign({},o.headers||{},{Authorization:`Bearer ${r}`}),a=await fetch(t,{method:e,...o,headers:n});if(a.status===401){if(!await U())throw new Error("Sesión de Dropbox expirada");return x(e,t,o)}return a}async function q(){try{const e=await x("POST","https://api.dropboxapi.com/2/users/get_current_account",{headers:{"Content-Type":"application/json"},body:"null"});return e.ok&&(await e.json()).name?.display_name||null}catch{return null}}async function R(){const e=await x("POST","https://content.dropboxapi.com/2/files/download",{headers:{"Dropbox-API-Arg":JSON.stringify({path:I})}});if(e.status===409)return null;if(!e.ok)throw new Error("Descarga de Dropbox fallida");const t=await e.text();try{return JSON.parse(t)}catch{return null}}async function Q(e){const t=e.split("/").filter(Boolean);if(t.length<=1)return;const o="/"+t.slice(0,t.length-1).join("/");try{await x("POST","https://api.dropboxapi.com/2/files/create_folder_v2",{headers:{"Content-Type":"application/json"},body:JSON.stringify({path:o,autorename:!1})})}catch{}}async function $(e){const t=JSON.stringify(e);if(await Q(I),!(await x("POST","https://content.dropboxapi.com/2/files/upload",{headers:{"Content-Type":"application/octet-stream","Dropbox-API-Arg":JSON.stringify({path:I,mode:"overwrite",mute:!0})},body:t})).ok)throw new Error("Subida a Dropbox fallida")}async function W(){if(!await B()){g(!1);return}const t=await q();g(!0,t);try{const o=await R(),r=p(),n=Number(localStorage.getItem("linksUpdatedAt")||"0"),a=Number(o?.updatedAt||0);o&&a>=n?(localStorage.setItem("linksUpdatedAt",String(a)),localStorage.setItem("links",JSON.stringify(o.links||[])),f(),b()):await $({links:r,updatedAt:h(),schema:1})}catch(o){console.warn("Sync inicial Dropbox:",o)}}function P(e=800){T()&&(v&&clearTimeout(v),v=setTimeout(()=>{F().catch(()=>{})},e))}async function F(){if(S)return;if(!await B()){g(!1);return}S=!0,m.textContent="Dropbox: sincronizando...";try{const t=await R(),o=p(),r=Number(localStorage.getItem("linksUpdatedAt")||"0"),n=Number(t?.updatedAt||0);if(t&&n>r)localStorage.setItem("links",JSON.stringify(t.links||[])),localStorage.setItem("linksUpdatedAt",String(n)),f(),b();else if(r>=n){const c=h();await $({links:o,updatedAt:c,schema:1}),localStorage.setItem("linksUpdatedAt",String(c))}const a=await q();g(!0,a),m.textContent="Dropbox: sincronizado"}catch(t){console.warn("Sync Dropbox:",t),m.textContent="Dropbox: error de sincronización"}finally{S=!1}}A.addEventListener("click",Y);L.addEventListener("click",()=>{C(null),g(!1)});E.addEventListener("click",()=>{F()});window.addEventListener("online",()=>P(200));(async function(){try{const t=new URL(window.location.href),o=t.searchParams.get("code");o&&(await G(o),t.searchParams.delete("code"),t.searchParams.delete("state"),history.replaceState({},"",t.toString()))}catch(t){console.warn("OAuth Dropbox:",t)}finally{u=T(),g(!!u),u&&(W(),setInterval(()=>P(0),5*60*1e3))}})();
