(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(n){if(n.ep)return;n.ep=!0;const r=o(n);fetch(n.href,r)}})();const W=document.querySelector("#app");W.innerHTML=`
  <h1>LinkHub</h1>
  <div id="dropbox-bar" style="display:flex;gap:0.5em;align-items:center;margin-bottom:0.75em;">
    <span id="dropbox-status" style="font-size:0.9em;color:#888;">Dropbox: desconectado</span>
    <button id="dropbox-connect" type="button">Conectar Dropbox</button>
    <button id="dropbox-sync" type="button" disabled>Sincronizar ahora</button>
  </div>
  <form id="link-form">
    <input type="url" id="url" placeholder="Enlace (https://...)" required />
    <input type="text" id="title" placeholder="Título" required />
    <input type="text" id="tags" list="tags-datalist" placeholder="Etiquetas (separadas por coma)" />
    <datalist id="tags-datalist"></datalist>
    <input type="text" id="category" list="categories-datalist" placeholder="Categoría" />
    <datalist id="categories-datalist"></datalist>
    <button type="submit">Añadir enlace</button>
  </form>
  <div style="margin:1em 0;">
    <button id="export-btn">Exportar enlaces</button>
    <input type="file" id="import-file" accept="application/json" style="display:none;" />
    <button id="import-btn" type="button">Importar enlaces</button>
  </div>
  <div style="margin:1em 0;">
    <input type="text" id="search" placeholder="Buscar enlaces..." style="width:60%;max-width:400px;" />
  </div>
  <div style="margin:1em 0;">
    <label>Filtrar por categoría:
      <select id="filter-category">
        <option value="">Todas</option>
      </select>
    </label>
    <label style="margin-left:1em;">Filtrar por etiqueta:
      <select id="filter-tag">
        <option value="">Todas</option>
      </select>
    </label>
  </div>
  <h2>Enlaces guardados</h2>
  <div id="links-list"></div>
  <footer style="margin-top:2em;color:#888;font-size:0.9em;">SW: <span id="sw-version">(cargando...)</span></footer>
`;let w=null;(function(){try{let e=function(){i.classList.add("open"),i.setAttribute("aria-hidden","false")},o=function(){i.classList.remove("open"),i.setAttribute("aria-hidden","true")},a=function(d){const b=window.matchMedia&&window.matchMedia("(prefers-color-scheme: light)").matches,oe=(d==="auto"?b?"light":"dark":d)==="light"?"#ffffff":"#242424";let y=document.querySelector('meta[name="theme-color"][data-override]');y||(y=document.createElement("meta"),y.setAttribute("name","theme-color"),y.setAttribute("data-override","true"),document.head.appendChild(y)),y.setAttribute("content",oe)},n=function(d){const b=document.documentElement;b.classList.remove("theme-light","theme-dark"),d==="light"?b.classList.add("theme-light"):d==="dark"&&b.classList.add("theme-dark"),a(d)};const r=document.getElementById("link-form"),c=document.createElement("div");c.style.margin="0.5em 0",c.id="settings-trigger";const m=document.createElement("button");m.id="settings-open",m.type="button",m.textContent="Configuración",c.appendChild(m),r&&r.parentNode&&r.insertAdjacentElement("afterend",c),W.insertAdjacentHTML("beforeend",`
      <div id="settings-modal" class="modal-backdrop" aria-hidden="true">
        <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="settings-title">
          <div class="modal-header">
            <h2 id="settings-title">Configuración</h2>
            <button id="settings-close" type="button" aria-label="Cerrar">✕</button>
          </div>
          <div class="modal-section">
            <h3>Tema</h3>
            <label for="theme-select">Modo:</label>
            <select id="theme-select">
              <option value="auto">Automático (sistema)</option>
              <option value="light">Claro</option>
              <option value="dark">Oscuro</option>
            </select>
          </div>
          <div class="modal-section">
            <h3>Dropbox</h3>
            <div id="modal-dropbox"></div>
          </div>
          <div class="modal-section">
            <h3>Datos</h3>
            <div id="modal-data"></div>
          </div>
          <div class="modal-footer">
            <button id="settings-close-2" type="button">Cerrar</button>
          </div>
        </div>
      </div>
    `);const i=document.getElementById("settings-modal"),s=i.querySelector("#theme-select"),l=i.querySelector("#modal-dropbox"),Q=i.querySelector("#modal-data"),_=document.getElementById("dropbox-bar");if(_){l.appendChild(_);const d=document.createElement("button");d.id="dropbox-disconnect",d.type="button",d.textContent="Desconectar",d.disabled=!0,_.appendChild(d),w=d}const L=document.getElementById("export-btn");if(L&&L.parentElement){const d=L.parentElement;Q.appendChild(d)}const Z=document.getElementById("settings-open"),ee=document.getElementById("settings-close"),te=document.getElementById("settings-close-2");Z.addEventListener("click",e),ee.addEventListener("click",o),te.addEventListener("click",o),i.addEventListener("click",d=>{d.target===i&&o()});const R=localStorage.getItem("themeMode")||"auto";n(R),s&&(s.value=R,s.addEventListener("change",()=>{const d=s.value;localStorage.setItem("themeMode",d),n(d)})),window.matchMedia&&window.matchMedia("(prefers-color-scheme: light)").addEventListener("change",()=>{(localStorage.getItem("themeMode")||"auto")==="auto"&&n("auto")})}catch(e){console.warn("Settings modal setup error:",e)}})();const u=document.getElementById("link-form"),$=document.getElementById("links-list"),ne=document.getElementById("export-btn"),ae=document.getElementById("import-btn"),C=document.getElementById("import-file"),j=document.getElementById("filter-category"),P=document.getElementById("filter-tag"),z=document.getElementById("search"),F=document.getElementById("tags-datalist"),J=document.getElementById("categories-datalist"),h=document.getElementById("dropbox-status"),B=document.getElementById("dropbox-connect"),O=document.getElementById("dropbox-sync"),H=document.getElementById("sw-version");function f(){return JSON.parse(localStorage.getItem("links")||"[]")}function E(t){localStorage.setItem("links",JSON.stringify(t)),localStorage.setItem("linksUpdatedAt",String(Date.now())),q()}function re(t){return Array.from(new Set(t.map(e=>(e.category||"").trim()).filter(Boolean)))}function ie(t){return Array.from(new Set(t.flatMap(e=>(e.tags||[]).map(o=>o.trim())).filter(Boolean)))}function x(){const t=f(),e=re(t).sort((a,n)=>a.localeCompare(n,"es",{sensitivity:"base"})),o=ie(t).sort((a,n)=>a.localeCompare(n,"es",{sensitivity:"base"}));j.innerHTML='<option value="">Todas</option>'+e.map(a=>`<option value="${a}">${a}</option>`).join(""),P.innerHTML='<option value="">Todas</option>'+o.map(a=>`<option value="${a}">${a}</option>`).join(""),J&&(J.innerHTML=e.map(a=>`<option value="${a}"></option>`).join("")),F&&(F.innerHTML=o.map(a=>`<option value="${a}"></option>`).join(""))}function g(){const t=f();let e=t;const o=j.value,a=P.value,n=(z.value||"").toLowerCase();if(o&&(e=e.filter(i=>(i.category||"")===o)),a&&(e=e.filter(i=>(i.tags||[]).map(String).includes(a))),n&&(e=e.filter(i=>i.title&&i.title.toLowerCase().includes(n)||i.url&&i.url.toLowerCase().includes(n)||i.category&&i.category.toLowerCase().includes(n)||i.tags&&i.tags.join(",").toLowerCase().includes(n))),e.length===0){$.innerHTML="<p>No hay enlaces guardados.</p>";return}const r=e.filter(i=>i.pinned),c=e.filter(i=>!i.pinned);r.sort((i,s)=>(i.title||"").localeCompare(s.title||"","es",{sensitivity:"base"})),c.sort((i,s)=>(i.title||"").localeCompare(s.title||"","es",{sensitivity:"base"}));const m=i=>i.map((s,l)=>`
    <div class="link-item${s.pinned?" pinned":""}" data-idx="${t.indexOf(s)}">
      <a href="${s.url}" target="_blank">${s.title}</a>
      <div><strong>Categoría:</strong> ${s.category||"-"}</div>
      <div><strong>Etiquetas:</strong> ${s.tags?s.tags.join(", "):"-"}</div>
      <button class="edit-link" style="margin-top:0.5em;">Editar</button>
      <button class="pin-link" style="margin-top:0.5em;">${s.pinned?"Desfijar":"Fijar"}</button>
      <button class="delete-link btn--danger" style="margin-top:0.5em;">Eliminar</button>
      <button class="share-link btn--ghost" style="margin-top:0.5em;">Compartir</button>
    </div>
  `).join("");$.innerHTML=(r.length?'<div style="font-size:0.95em;color:#535bf2;margin-bottom:0.5em;">Fijados</div>'+m(r):"")+m(c),document.querySelectorAll(".edit-link").forEach(i=>{i.onclick=function(){const s=this.parentElement.getAttribute("data-idx"),l=f()[s];u.url.value=l.url,u.title.value=l.title,u.tags.value=(l.tags||[]).join(", "),u.category.value=l.category||"",u.setAttribute("data-edit",s),u.querySelector('button[type="submit"]').textContent="Guardar cambios",u.scrollIntoView({behavior:"smooth"})}}),document.querySelectorAll(".pin-link").forEach(i=>{i.onclick=function(){const s=this.parentElement.getAttribute("data-idx"),l=f();l[s].pinned=!l[s].pinned,E(l),g()}}),document.querySelectorAll(".delete-link").forEach(i=>{i.onclick=function(){const s=this.parentElement.getAttribute("data-idx");if(confirm("¿Seguro que quieres eliminar este enlace?")){const l=f();l.splice(s,1),E(l),g(),x()}}}),document.querySelectorAll(".share-link").forEach(i=>{i.onclick=function(){const s=this.parentElement.getAttribute("data-idx"),l=f()[s];navigator.share?navigator.share({title:l.title,text:l.title+(l.category?" ["+l.category+"]":""),url:l.url}):(navigator.clipboard.writeText(l.url),alert("Enlace copiado al portapapeles"))}})}u.addEventListener("submit",t=>{t.preventDefault();const e=u.url.value.trim(),o=u.title.value.trim(),a=u.tags.value.split(",").map(m=>m.trim()).filter(Boolean),n=u.category.value.trim(),r=f(),c=u.getAttribute("data-edit");if(c!==null){const m=r[c]||{};r[c]={...m,url:e,title:o,tags:a,category:n},u.removeAttribute("data-edit"),u.querySelector('button[type="submit"]').textContent="Añadir enlace"}else r.push({url:e,title:o,tags:a,category:n,pinned:!1});E(r),u.reset(),g(),x()});ne.addEventListener("click",()=>{const t=f(),e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),o=URL.createObjectURL(e),a=document.createElement("a");a.href=o,a.download="enlaces-linkhub.json",a.click(),URL.revokeObjectURL(o)});ae.addEventListener("click",()=>{C.click()});C.addEventListener("change",t=>{const e=t.target.files[0];if(!e)return;const o=new FileReader;o.onload=a=>{try{const n=JSON.parse(a.target.result);Array.isArray(n)?(E(n),g(),x(),alert("Enlaces importados correctamente.")):alert("El archivo no tiene el formato esperado.")}catch{alert("Error al importar el archivo.")}},o.readAsText(e),C.value=""});j.addEventListener("change",()=>{g()});P.addEventListener("change",()=>{g()});z.addEventListener("input",g);x();g();const A=window.VITE_DROPBOX_APP_KEY||"",D="/linkhub/links.json";let p=null,I=null,T=!1;function v(t,e){t?(h.textContent=`Dropbox: conectado${e?" ("+e+")":""}`,h.style.color="#1a7f37",B.disabled=!0,O.disabled=!1,w&&(w.disabled=!1)):(h.textContent="Dropbox: desconectado",h.style.color="#888",B.disabled=!1,O.disabled=!0,w&&(w.disabled=!0))}function k(){return Date.now()}function N(){try{return JSON.parse(localStorage.getItem("dropboxAuth")||"null")}catch{return null}}function M(t){p=t,t?localStorage.setItem("dropboxAuth",JSON.stringify(t)):localStorage.removeItem("dropboxAuth")}async function se(t){const o=new TextEncoder().encode(t),a=await crypto.subtle.digest("SHA-256",o),n=new Uint8Array(a);let r="";for(let c=0;c<n.length;c++)r+=String.fromCharCode(n[c]);return btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function ce(t=64){const e=new Uint8Array(t);return crypto.getRandomValues(e),Array.from(e).map(o=>("0"+o.toString(16)).slice(-2)).join("")}async function le(){if(!A){alert("Falta configurar VITE_DROPBOX_APP_KEY.");return}const t=ce(64),e=await se(t);sessionStorage.setItem("dbx_code_verifier",t);const o=window.location.origin+window.location.pathname,n=`https://www.dropbox.com/oauth2/authorize?${new URLSearchParams({client_id:A,response_type:"code",code_challenge:e,code_challenge_method:"S256",token_access_type:"offline",redirect_uri:o}).toString()}`;window.location.assign(n)}async function de(t){const e=sessionStorage.getItem("dbx_code_verifier"),o=window.location.origin+window.location.pathname,a=new URLSearchParams({code:t,grant_type:"authorization_code",client_id:A,redirect_uri:o,code_verifier:e||""}),n=await fetch("https://api.dropboxapi.com/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:a});if(!n.ok)throw new Error("No se pudo obtener el token de Dropbox");const r=await n.json(),c=k()+(r.expires_in?r.expires_in*1e3-60*1e3:3*3600*1e3);M({access_token:r.access_token,refresh_token:r.refresh_token||null,expires_at:c,account_id:r.account_id||null})}async function V(){if(!p?.refresh_token)return!1;const t=new URLSearchParams({grant_type:"refresh_token",refresh_token:p.refresh_token,client_id:A}),e=await fetch("https://api.dropboxapi.com/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t});if(!e.ok)return!1;const o=await e.json();return p.access_token=o.access_token,p.expires_at=k()+(o.expires_in?o.expires_in*1e3-60*1e3:3*3600*1e3),M(p),!0}async function U(){return p=p||N(),!p||p.expires_at&&p.expires_at<k()&&!await V()?null:p.access_token}async function S(t,e,o={}){const a=await U();if(!a)throw new Error("No autenticado en Dropbox");const n=Object.assign({},o.headers||{},{Authorization:`Bearer ${a}`}),r=await fetch(e,{method:t,...o,headers:n});if(r.status===401){if(!await V())throw new Error("Sesión de Dropbox expirada");return S(t,e,o)}return r}async function G(){try{const t=await S("POST","https://api.dropboxapi.com/2/users/get_current_account",{headers:{"Content-Type":"application/json"},body:"null"});return t.ok&&(await t.json()).name?.display_name||null}catch{return null}}async function K(){const t=await S("POST","https://content.dropboxapi.com/2/files/download",{headers:{"Dropbox-API-Arg":JSON.stringify({path:D})}});if(t.status===409)return null;if(!t.ok)throw new Error("Descarga de Dropbox fallida");const e=await t.text();try{return JSON.parse(e)}catch{return null}}async function ue(t){const e=t.split("/").filter(Boolean);if(e.length<=1)return;const o="/"+e.slice(0,e.length-1).join("/");try{await S("POST","https://api.dropboxapi.com/2/files/create_folder_v2",{headers:{"Content-Type":"application/json"},body:JSON.stringify({path:o,autorename:!1})})}catch{}}async function X(t){const e=JSON.stringify(t);if(await ue(D),!(await S("POST","https://content.dropboxapi.com/2/files/upload",{headers:{"Content-Type":"application/octet-stream","Dropbox-API-Arg":JSON.stringify({path:D,mode:"overwrite",mute:!0})},body:e})).ok)throw new Error("Subida a Dropbox fallida")}async function pe(){if(!await U()){v(!1);return}const e=await G();v(!0,e);try{const o=await K(),a=f(),n=Number(localStorage.getItem("linksUpdatedAt")||"0"),r=Number(o?.updatedAt||0);o&&r>=n?(localStorage.setItem("linksUpdatedAt",String(r)),localStorage.setItem("links",JSON.stringify(o.links||[])),g(),x()):await X({links:a,updatedAt:k(),schema:1})}catch(o){console.warn("Sync inicial Dropbox:",o)}}function q(t=800){N()&&(I&&clearTimeout(I),I=setTimeout(()=>{Y().catch(()=>{})},t))}async function Y(){if(T)return;if(!await U()){v(!1);return}T=!0,h.textContent="Dropbox: sincronizando...";try{const e=await K(),o=f(),a=Number(localStorage.getItem("linksUpdatedAt")||"0"),n=Number(e?.updatedAt||0);if(e&&n>a)localStorage.setItem("links",JSON.stringify(e.links||[])),localStorage.setItem("linksUpdatedAt",String(n)),g(),x();else if(a>=n){const c=k();await X({links:o,updatedAt:c,schema:1}),localStorage.setItem("linksUpdatedAt",String(c))}const r=await G();v(!0,r),h.textContent="Dropbox: sincronizado"}catch(e){console.warn("Sync Dropbox:",e),h.textContent="Dropbox: error de sincronización"}finally{T=!1}}B.addEventListener("click",le);O.addEventListener("click",()=>{Y()});document.addEventListener("click",t=>{const e=t.target;e&&e.id==="dropbox-disconnect"&&(M(null),v(!1))});window.addEventListener("online",()=>q(200));function me(){if("serviceWorker"in navigator){if(navigator.serviceWorker.controller)try{navigator.serviceWorker.controller.postMessage({type:"GET_SW_VERSION"})}catch{}navigator.serviceWorker.ready&&navigator.serviceWorker.ready.then(t=>{try{t&&t.active&&t.active.postMessage({type:"GET_SW_VERSION"})}catch{}}).catch(()=>{})}}"serviceWorker"in navigator&&(navigator.serviceWorker.addEventListener("message",t=>{const e=t.data||{};e.type==="SW_VERSION"&&H&&(H.textContent=String(e.version))}),setTimeout(me,500));(async function(){try{const e=new URL(window.location.href),o=e.searchParams.get("code");o&&(await de(o),e.searchParams.delete("code"),e.searchParams.delete("state"),history.replaceState({},"",e.toString()))}catch(e){console.warn("OAuth Dropbox:",e)}finally{p=N(),v(!!p),p&&(pe(),setInterval(()=>q(0),5*60*1e3))}})();
