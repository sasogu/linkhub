(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const _=document.querySelector("#app");_.innerHTML=`
  <h1>LinkHub</h1>
  <div id="dropbox-bar" style="display:flex;gap:0.5em;align-items:center;margin-bottom:0.75em;">
    <span id="dropbox-status" style="font-size:0.9em;color:#888;">Dropbox: desconectado</span>
    <button id="dropbox-connect" type="button">Conectar Dropbox</button>
    <button id="dropbox-sync" type="button" disabled>Sincronizar ahora</button>
  </div>
  <form id="link-form">
    <input type="url" id="url" placeholder="Enlace (https://...)" required />
    <input type="text" id="title" placeholder="Título" required />
    <input type="text" id="tags" placeholder="Etiquetas (separadas por coma)" />
    <input type="text" id="category" placeholder="Categoría" />
    <button type="submit">Añadir enlace</button>
  </form>
  <div style="margin:1em 0;">
    <button id="export-btn">Exportar enlaces</button>
    <input type="file" id="import-file" accept="application/json" style="display:none;" />
    <button id="import-btn" type="button">Importar enlaces</button>
  </div>
  <div style="margin:1em 0;">
    <input type="text" id="search" placeholder="Buscar enlaces..." style="width:60%;max-width:400px;" />
  </div>
  <div style="margin:1em 0;">
    <label>Filtrar por categoría:
      <select id="filter-category">
        <option value="">Todas</option>
      </select>
    </label>
    <label style="margin-left:1em;">Filtrar por etiqueta:
      <select id="filter-tag">
        <option value="">Todas</option>
      </select>
    </label>
  </div>
  <h2>Enlaces guardados</h2>
  <div id="links-list"></div>
  <footer style="margin-top:2em;color:#888;font-size:0.9em;">SW: <span id="sw-version">(cargando...)</span></footer>
`;(function(){try{let e=function(){s.classList.add("open"),s.setAttribute("aria-hidden","false")},n=function(){s.classList.remove("open"),s.setAttribute("aria-hidden","true")};const r=_.querySelector("h1"),o=document.createElement("div");o.style.margin="0.5em 0",o.id="settings-trigger";const i=document.createElement("button");i.id="settings-open",i.type="button",i.textContent="Configuración",o.appendChild(i),r&&r.parentNode&&r.parentNode.insertBefore(o,r.nextSibling),_.insertAdjacentHTML("beforeend",`
      <div id="settings-modal" class="modal-backdrop" aria-hidden="true">
        <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="settings-title">
          <div class="modal-header">
            <h2 id="settings-title">Configuración</h2>
            <button id="settings-close" type="button" aria-label="Cerrar">✕</button>
          </div>
          <div class="modal-section">
            <h3>Dropbox</h3>
            <div id="modal-dropbox"></div>
          </div>
          <div class="modal-section">
            <h3>Datos</h3>
            <div id="modal-data"></div>
          </div>
          <div class="modal-footer">
            <button id="settings-close-2" type="button">Cerrar</button>
          </div>
        </div>
      </div>
    `);const s=document.getElementById("settings-modal"),g=s.querySelector("#modal-dropbox"),a=s.querySelector("#modal-data"),c=document.getElementById("dropbox-bar");c&&g.appendChild(c);const l=document.getElementById("export-btn");if(l&&l.parentElement){const k=l.parentElement;a.appendChild(k)}const W=document.getElementById("settings-open"),z=document.getElementById("settings-close"),H=document.getElementById("settings-close-2");W.addEventListener("click",e),z.addEventListener("click",n),H.addEventListener("click",n),s.addEventListener("click",k=>{k.target===s&&n()})}catch(e){console.warn("Settings modal setup error:",e)}})();const d=document.getElementById("link-form"),P=document.getElementById("links-list"),V=document.getElementById("export-btn"),G=document.getElementById("import-btn"),A=document.getElementById("import-file"),C=document.getElementById("filter-category"),B=document.getElementById("filter-tag"),U=document.getElementById("search"),f=document.getElementById("dropbox-status"),I=document.getElementById("dropbox-connect"),L=document.getElementById("dropbox-sync"),j=document.getElementById("sw-version");function p(){return JSON.parse(localStorage.getItem("links")||"[]")}function x(t){localStorage.setItem("links",JSON.stringify(t)),localStorage.setItem("linksUpdatedAt",String(Date.now())),N()}function K(t){return Array.from(new Set(t.map(e=>(e.category||"").trim()).filter(Boolean)))}function X(t){return Array.from(new Set(t.flatMap(e=>(e.tags||[]).map(n=>n.trim())).filter(Boolean)))}function y(){const t=p(),e=K(t).sort((r,o)=>r.localeCompare(o,"es",{sensitivity:"base"})),n=X(t).sort((r,o)=>r.localeCompare(o,"es",{sensitivity:"base"}));C.innerHTML='<option value="">Todas</option>'+e.map(r=>`<option value="${r}">${r}</option>`).join(""),B.innerHTML='<option value="">Todas</option>'+n.map(r=>`<option value="${r}">${r}</option>`).join("")}function m(){const t=p();let e=t;const n=C.value,r=B.value,o=(U.value||"").toLowerCase();if(n&&(e=e.filter(a=>(a.category||"")===n)),r&&(e=e.filter(a=>(a.tags||[]).map(String).includes(r))),o&&(e=e.filter(a=>a.title&&a.title.toLowerCase().includes(o)||a.url&&a.url.toLowerCase().includes(o)||a.category&&a.category.toLowerCase().includes(o)||a.tags&&a.tags.join(",").toLowerCase().includes(o))),e.length===0){P.innerHTML="<p>No hay enlaces guardados.</p>";return}const i=e.filter(a=>a.pinned),s=e.filter(a=>!a.pinned);i.sort((a,c)=>(a.title||"").localeCompare(c.title||"","es",{sensitivity:"base"})),s.sort((a,c)=>(a.title||"").localeCompare(c.title||"","es",{sensitivity:"base"}));const g=a=>a.map((c,l)=>`
    <div class="link-item${c.pinned?" pinned":""}" data-idx="${t.indexOf(c)}">
      <a href="${c.url}" target="_blank">${c.title}</a>
      <div><strong>Categoría:</strong> ${c.category||"-"}</div>
      <div><strong>Etiquetas:</strong> ${c.tags?c.tags.join(", "):"-"}</div>
      <button class="edit-link" style="margin-top:0.5em;">Editar</button>
      <button class="pin-link" style="margin-top:0.5em;">${c.pinned?"Desfijar":"Fijar"}</button>
      <button class="delete-link" style="margin-top:0.5em;color:#c00;background:#fff3f3;border:1px solid #c00;">Eliminar</button>
      <button class="share-link" style="margin-top:0.5em;color:#1a7f37;background:#e6fff3;border:1px solid #1a7f37;">Compartir</button>
    </div>
  `).join("");P.innerHTML=(i.length?'<div style="font-size:0.95em;color:#535bf2;margin-bottom:0.5em;">Fijados</div>'+g(i):"")+g(s),document.querySelectorAll(".edit-link").forEach(a=>{a.onclick=function(){const c=this.parentElement.getAttribute("data-idx"),l=p()[c];d.url.value=l.url,d.title.value=l.title,d.tags.value=(l.tags||[]).join(", "),d.category.value=l.category||"",d.setAttribute("data-edit",c),d.querySelector('button[type="submit"]').textContent="Guardar cambios",d.scrollIntoView({behavior:"smooth"})}}),document.querySelectorAll(".pin-link").forEach(a=>{a.onclick=function(){const c=this.parentElement.getAttribute("data-idx"),l=p();l[c].pinned=!l[c].pinned,x(l),m()}}),document.querySelectorAll(".delete-link").forEach(a=>{a.onclick=function(){const c=this.parentElement.getAttribute("data-idx");if(confirm("¿Seguro que quieres eliminar este enlace?")){const l=p();l.splice(c,1),x(l),m(),y()}}}),document.querySelectorAll(".share-link").forEach(a=>{a.onclick=function(){const c=this.parentElement.getAttribute("data-idx"),l=p()[c];navigator.share?navigator.share({title:l.title,text:l.title+(l.category?" ["+l.category+"]":""),url:l.url}):(navigator.clipboard.writeText(l.url),alert("Enlace copiado al portapapeles"))}})}d.addEventListener("submit",t=>{t.preventDefault();const e=d.url.value.trim(),n=d.title.value.trim(),r=d.tags.value.split(",").map(g=>g.trim()).filter(Boolean),o=d.category.value.trim(),i=p(),s=d.getAttribute("data-edit");s!==null?(i[s]={url:e,title:n,tags:r,category:o},d.removeAttribute("data-edit"),d.querySelector('button[type="submit"]').textContent="Añadir enlace"):i.push({url:e,title:n,tags:r,category:o}),x(i),d.reset(),m(),y()});V.addEventListener("click",()=>{const t=p(),e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),n=URL.createObjectURL(e),r=document.createElement("a");r.href=n,r.download="enlaces-linkhub.json",r.click(),URL.revokeObjectURL(n)});G.addEventListener("click",()=>{A.click()});A.addEventListener("change",t=>{const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=r=>{try{const o=JSON.parse(r.target.result);Array.isArray(o)?(x(o),m(),y(),alert("Enlaces importados correctamente.")):alert("El archivo no tiene el formato esperado.")}catch{alert("Error al importar el archivo.")}},n.readAsText(e),A.value=""});C.addEventListener("change",()=>{m()});B.addEventListener("change",()=>{m()});U.addEventListener("input",m);y();m();const w=window.VITE_DROPBOX_APP_KEY||"",O="/linkhub/links.json";let u=null,S=null,E=!1;function b(t,e){t?(f.textContent=`Dropbox: conectado${e?" ("+e+")":""}`,f.style.color="#1a7f37",I.disabled=!0,L.disabled=!1):(f.textContent="Dropbox: desconectado",f.style.color="#888",I.disabled=!1,L.disabled=!0)}function h(){return Date.now()}function T(){try{return JSON.parse(localStorage.getItem("dropboxAuth")||"null")}catch{return null}}function q(t){u=t,t?localStorage.setItem("dropboxAuth",JSON.stringify(t)):localStorage.removeItem("dropboxAuth")}async function Y(t){const n=new TextEncoder().encode(t),r=await crypto.subtle.digest("SHA-256",n),o=new Uint8Array(r);let i="";for(let s=0;s<o.length;s++)i+=String.fromCharCode(o[s]);return btoa(i).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Q(t=64){const e=new Uint8Array(t);return crypto.getRandomValues(e),Array.from(e).map(n=>("0"+n.toString(16)).slice(-2)).join("")}async function Z(){if(!w){alert("Falta configurar VITE_DROPBOX_APP_KEY.");return}const t=Q(64),e=await Y(t);sessionStorage.setItem("dbx_code_verifier",t);const n=window.location.origin+window.location.pathname,o=`https://www.dropbox.com/oauth2/authorize?${new URLSearchParams({client_id:w,response_type:"code",code_challenge:e,code_challenge_method:"S256",token_access_type:"offline",redirect_uri:n}).toString()}`;window.location.assign(o)}async function ee(t){const e=sessionStorage.getItem("dbx_code_verifier"),n=window.location.origin+window.location.pathname,r=new URLSearchParams({code:t,grant_type:"authorization_code",client_id:w,redirect_uri:n,code_verifier:e||""}),o=await fetch("https://api.dropboxapi.com/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r});if(!o.ok)throw new Error("No se pudo obtener el token de Dropbox");const i=await o.json(),s=h()+(i.expires_in?i.expires_in*1e3-60*1e3:3*3600*1e3);q({access_token:i.access_token,refresh_token:i.refresh_token||null,expires_at:s,account_id:i.account_id||null})}async function R(){if(!u?.refresh_token)return!1;const t=new URLSearchParams({grant_type:"refresh_token",refresh_token:u.refresh_token,client_id:w}),e=await fetch("https://api.dropboxapi.com/oauth2/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t});if(!e.ok)return!1;const n=await e.json();return u.access_token=n.access_token,u.expires_at=h()+(n.expires_in?n.expires_in*1e3-60*1e3:3*3600*1e3),q(u),!0}async function D(){return u=u||T(),!u||u.expires_at&&u.expires_at<h()&&!await R()?null:u.access_token}async function v(t,e,n={}){const r=await D();if(!r)throw new Error("No autenticado en Dropbox");const o=Object.assign({},n.headers||{},{Authorization:`Bearer ${r}`}),i=await fetch(e,{method:t,...n,headers:o});if(i.status===401){if(!await R())throw new Error("Sesión de Dropbox expirada");return v(t,e,n)}return i}async function $(){try{const t=await v("POST","https://api.dropboxapi.com/2/users/get_current_account",{headers:{"Content-Type":"application/json"},body:"null"});return t.ok&&(await t.json()).name?.display_name||null}catch{return null}}async function F(){const t=await v("POST","https://content.dropboxapi.com/2/files/download",{headers:{"Dropbox-API-Arg":JSON.stringify({path:O})}});if(t.status===409)return null;if(!t.ok)throw new Error("Descarga de Dropbox fallida");const e=await t.text();try{return JSON.parse(e)}catch{return null}}async function te(t){const e=t.split("/").filter(Boolean);if(e.length<=1)return;const n="/"+e.slice(0,e.length-1).join("/");try{await v("POST","https://api.dropboxapi.com/2/files/create_folder_v2",{headers:{"Content-Type":"application/json"},body:JSON.stringify({path:n,autorename:!1})})}catch{}}async function J(t){const e=JSON.stringify(t);if(await te(O),!(await v("POST","https://content.dropboxapi.com/2/files/upload",{headers:{"Content-Type":"application/octet-stream","Dropbox-API-Arg":JSON.stringify({path:O,mode:"overwrite",mute:!0})},body:e})).ok)throw new Error("Subida a Dropbox fallida")}async function oe(){if(!await D()){b(!1);return}const e=await $();b(!0,e);try{const n=await F(),r=p(),o=Number(localStorage.getItem("linksUpdatedAt")||"0"),i=Number(n?.updatedAt||0);n&&i>=o?(localStorage.setItem("linksUpdatedAt",String(i)),localStorage.setItem("links",JSON.stringify(n.links||[])),m(),y()):await J({links:r,updatedAt:h(),schema:1})}catch(n){console.warn("Sync inicial Dropbox:",n)}}function N(t=800){T()&&(S&&clearTimeout(S),S=setTimeout(()=>{M().catch(()=>{})},t))}async function M(){if(E)return;if(!await D()){b(!1);return}E=!0,f.textContent="Dropbox: sincronizando...";try{const e=await F(),n=p(),r=Number(localStorage.getItem("linksUpdatedAt")||"0"),o=Number(e?.updatedAt||0);if(e&&o>r)localStorage.setItem("links",JSON.stringify(e.links||[])),localStorage.setItem("linksUpdatedAt",String(o)),m(),y();else if(r>=o){const s=h();await J({links:n,updatedAt:s,schema:1}),localStorage.setItem("linksUpdatedAt",String(s))}const i=await $();b(!0,i),f.textContent="Dropbox: sincronizado"}catch(e){console.warn("Sync Dropbox:",e),f.textContent="Dropbox: error de sincronización"}finally{E=!1}}I.addEventListener("click",Z);L.addEventListener("click",()=>{M()});window.addEventListener("online",()=>N(200));function ne(){if("serviceWorker"in navigator){if(navigator.serviceWorker.controller)try{navigator.serviceWorker.controller.postMessage({type:"GET_SW_VERSION"})}catch{}navigator.serviceWorker.ready&&navigator.serviceWorker.ready.then(t=>{try{t&&t.active&&t.active.postMessage({type:"GET_SW_VERSION"})}catch{}}).catch(()=>{})}}"serviceWorker"in navigator&&(navigator.serviceWorker.addEventListener("message",t=>{const e=t.data||{};e.type==="SW_VERSION"&&j&&(j.textContent=String(e.version))}),setTimeout(ne,500));(async function(){try{const e=new URL(window.location.href),n=e.searchParams.get("code");n&&(await ee(n),e.searchParams.delete("code"),e.searchParams.delete("state"),history.replaceState({},"",e.toString()))}catch(e){console.warn("OAuth Dropbox:",e)}finally{u=T(),b(!!u),u&&(oe(),setInterval(()=>N(0),5*60*1e3))}})();
